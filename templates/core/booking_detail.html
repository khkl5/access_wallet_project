{% extends "base.html" %}
{% load static %}

{% block content %}
<style>
  :root {
    --primary: #2563eb;
    --primary-soft: #dbeafe;
    --primary-dark: #1d4ed8;
    --danger: #ef4444;
    --success: #16a34a;
    --warning: #facc15;
    --muted: #6b7280;
    --bg-soft: #f3f4f6;
    --card-bg: #ffffff;
    --radius-lg: 18px;
    --shadow-soft: 0 18px 35px rgba(15, 23, 42, 0.08);
  }

  body {
    background: radial-gradient(circle at top, #e0f2fe 0, #f9fafb 45%, #f3f4f6 100%);
  }

  .booking-shell {
    direction: rtl;
    text-align: right;
  }

  .page-breadcrumb {
    font-size: 0.8rem;
    color: var(--muted);
    margin-bottom: 8px;
  }

  .page-breadcrumb a {
    color: var(--muted);
    text-decoration: none;
  }

  .page-breadcrumb a:hover {
    text-decoration: underline;
  }

  .booking-detail-layout {
    display: grid;
    grid-template-columns: minmax(0, 2fr) minmax(0, 1.4fr);
    gap: 18px;
    margin-top: 10px;
  }

  .booking-card,
  .pass-card {
    background: var(--card-bg);
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-soft);
    padding: 18px 20px;
    border: 1px solid rgba(148, 163, 184, 0.25);
    position: relative;
    overflow: hidden;
  }

  .booking-card::before,
  .pass-card::before {
    content: "";
    position: absolute;
    inset-inline-end: -70px;
    top: -80px;
    width: 170px;
    height: 170px;
    background: radial-gradient(circle, rgba(37, 99, 235, 0.14), transparent 70%);
    filter: blur(1px);
    pointer-events: none;
  }

  .card-header-line {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 8px;
    margin-bottom: 14px;
  }

  .card-header-line h3 {
    font-size: 1.02rem;
    margin: 0;
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .card-subtitle {
    font-size: 0.8rem;
    color: var(--muted);
  }

  .chip-small {
    font-size: 0.7rem;
    padding: 2px 8px;
    border-radius: 999px;
    background: var(--primary-soft);
    color: var(--primary-dark);
    font-weight: 600;
  }

  .detail-row {
    display: flex;
    flex-wrap: wrap;
    gap: 12px 18px;
    margin-bottom: 8px;
  }

  .detail-item {
    min-width: 45%;
  }

  .detail-label {
    font-size: 0.78rem;
    color: var(--muted);
    margin-bottom: 2px;
  }

  .detail-value {
    font-size: 0.9rem;
    font-weight: 500;
    color: #111827;
  }

  .badge-chip {
    border-radius: 999px;
    font-size: 0.78rem;
    padding: 5px 10px;
    display: inline-flex;
    align-items: center;
    gap: 5px;
  }

  .badge-chip-dot {
    width: 7px;
    height: 7px;
    border-radius: 999px;
    background: currentColor;
  }

  .badge-status-confirmed {
    background: rgba(22, 163, 74, 0.12);
    color: var(--success);
  }

  .badge-status-pending {
    background: rgba(250, 204, 21, 0.17);
    color: #854d0e;
  }

  .badge-status-cancelled {
    background: rgba(148, 163, 184, 0.18);
    color: #4b5563;
  }

  .badge-pass-active {
    background: rgba(22, 163, 74, 0.1);
    color: var(--success);
  }

  .badge-pass-expired {
    background: rgba(148, 163, 184, 0.18);
    color: #4b5563;
  }

  .badge-pass-cancelled {
    background: rgba(239, 68, 68, 0.12);
    color: var(--danger);
  }

  .badge-pass-none {
    background: rgba(229, 231, 235, 0.9);
    color: #374151;
  }

  .btn-main {
    border-radius: 999px;
    padding: 7px 16px;
    font-size: 0.9rem;
    display: inline-flex;
    align-items: center;
    gap: 6px;
    border: none;
    background: linear-gradient(135deg, var(--primary), var(--primary-dark));
    color: #fff !important;
    text-decoration: none;
    box-shadow: 0 10px 20px rgba(37, 99, 235, 0.35);
    transition: transform 0.15s ease, box-shadow 0.15s ease, opacity 0.15s ease;
  }

  .btn-main:hover {
    transform: translateY(-1px);
    box-shadow: 0 14px 26px rgba(37, 99, 235, 0.4);
    opacity: 0.95;
  }

  .btn-main-secondary {
    border-radius: 999px;
    padding: 6px 12px;
    font-size: 0.82rem;
    border: 1px solid rgba(148, 163, 184, 0.8);
    background: #f9fafb;
    color: #374151;
    display: inline-flex;
    align-items: center;
    gap: 5px;
    text-decoration: none;
  }

  .btn-main-secondary:hover {
    background: #e5e7eb;
  }

  .btn-outline-danger {
    border-radius: 999px;
    padding: 6px 12px;
    font-size: 0.8rem;
    border: 1px solid rgba(239, 68, 68, 0.7);
    background: rgba(254, 242, 242, 0.9);
    color: #b91c1c;
    display: inline-flex;
    align-items: center;
    gap: 5px;
    text-decoration: none;
  }

  .btn-outline-danger:hover {
    background: rgba(254, 226, 226, 1);
  }

  .pass-empty-state {
    padding: 14px 12px;
    background: #f9fafb;
    border-radius: 14px;
    border: 1px dashed rgba(148, 163, 184, 0.7);
    font-size: 0.86rem;
    color: var(--muted);
    margin-bottom: 12px;
  }

  .pass-url-box {
    background: #f9fafb;
    border-radius: 12px;
    border: 1px solid rgba(209, 213, 219, 0.9);
    padding: 8px 10px;
    display: flex;
    align-items: center;
    gap: 8px;
    justify-content: space-between;
    margin-bottom: 10px;
  }

  .pass-url-text {
    font-size: 0.8rem;
    color: #111827;
    overflow-wrap: anywhere;
  }

  .copy-badge {
    font-size: 0.78rem;
    padding: 5px 9px;
    border-radius: 999px;
    background: #e5e7eb;
    border: none;
  }

  .copy-badge:hover {
    background: #d1d5db;
  }

  .copy-badge.success {
    background: #dcfce7;
    color: #166534;
  }

  .detail-meta-inline {
    font-size: 0.78rem;
    color: var(--muted);
  }

  @media (max-width: 992px) {
    .booking-detail-layout {
      grid-template-columns: minmax(0, 1fr);
    }
  }
</style>

<div class="container mt-4 booking-shell">

  <!-- Ù…Ø³Ø§Ø± Ø¨Ø³ÙŠØ· Ø£Ø¹Ù„Ù‰ Ø§Ù„ØµÙØ­Ø© -->
  <div class="page-breadcrumb">
    <a href="{% url 'booking_list' %}">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª</a>
    <span> / </span>
    <span>ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø­Ø¬Ø² #{{ booking.id }}</span>
  </div>

  <!-- Ø§Ù„Ù‡ÙŠØ¯Ø± Ø§Ù„Ø¹Ø§Ù… -->
  <div class="card-header-line" style="margin-bottom: 16px;">
    <div>
      <h3>
        ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø­Ø¬Ø²
        <span class="chip-small">Ø±Ø¨Ø· Ø§Ù„Ø­Ø¬Ø² Ø¨Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø±Ù‚Ù…ÙŠØ©</span>
      </h3>
      <div class="card-subtitle">
        Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø© ØªÙˆØ¶Ø­ Ù„Ù„Ø¹Ù…ÙŠÙ„ Ø£Ù† Ø§Ù„Ù†Ø¸Ø§Ù… ÙŠØ±Ø¨Ø· Ø¨ÙŠÙ† Ø§Ù„Ø­Ø¬Ø²ØŒ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©ØŒ ÙˆØ§Ù„Ù…Ø¯Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ©.
      </div>
    </div>

    <a href="{% url 'booking_list' %}" class="btn-main-secondary">
      â† Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª
    </a>
  </div>

  <!-- ØªØ®Ø·ÙŠØ· Ø¹Ù…ÙˆØ¯ÙŠÙ†: Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø¬Ø² + Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© -->
  <div class="booking-detail-layout">

    <!-- ğŸ§¾ Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„Ø£ÙˆÙ„ â€“ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø­Ø¬Ø² -->
    <section class="booking-card">
      <div class="card-header-line">
        <h3>Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø­Ø¬Ø²</h3>
      </div>

      <div class="detail-row">
        <div class="detail-item">
          <div class="detail-label">Ø§Ø³Ù… Ø§Ù„Ù†Ø²ÙŠÙ„</div>
          <div class="detail-value">{{ booking.guest.full_name }}</div>
        </div>

        <div class="detail-item">
          <div class="detail-label">Ø§Ù„ØºØ±ÙØ©</div>
          <div class="detail-value">{{ booking.room }}</div>
        </div>
      </div>

      <div class="detail-row">
        <div class="detail-item">
          <div class="detail-label">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ù‚Ø§Ù…Ø©</div>
          <div class="detail-value">
            Ù…Ù† {{ booking.start_date|date:"d M Y" }} Ø­ØªÙ‰ {{ booking.end_date|date:"d M Y" }}
          </div>
        </div>

        <div class="detail-item">
          <div class="detail-label">Ù…Ø¯Ø© Ø§Ù„Ø¥Ù‚Ø§Ù…Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</div>
          <div class="detail-value">
            {{ booking.nights }} Ù„ÙŠÙ„Ø©
          </div>
        </div>
      </div>

      <div class="detail-row">
        <div class="detail-item">
          <div class="detail-label">Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø¬Ø²</div>
          <div class="detail-value">
            {% if booking.status == 'confirmed' %}
              <span class="badge badge-chip badge-status-confirmed">
                <span class="badge-chip-dot"></span>
                Ù…Ø¤ÙƒØ¯
              </span>
            {% elif booking.status == 'pending' %}
              <span class="badge badge-chip badge-status-pending">
                <span class="badge-chip-dot"></span>
                Ù‚ÙŠØ¯ Ø§Ù„ØªØ£ÙƒÙŠØ¯
              </span>
            {% elif booking.status == 'cancelled' %}
              <span class="badge badge-chip badge-status-cancelled">
                <span class="badge-chip-dot"></span>
                Ù…Ù„ØºÙ‰
              </span>
            {% else %}
              {{ booking.get_status_display }}
            {% endif %}
          </div>
        </div>

        <div class="detail-item">
          <div class="detail-label">Ø±Ù‚Ù… Ø§Ù„Ø­Ø¬Ø²</div>
          <div class="detail-value">#{{ booking.id }}</div>
        </div>
      </div>

      <div class="detail-row" style="margin-top: 10px;">
        <div class="detail-item">
          <div class="detail-label">Ù…Ù„Ø§Ø­Ø¸Ø§Øª (Ø¥Ù† ÙˆØ¬Ø¯Øª)</div>
          <div class="detail-value" style="font-size: 0.85rem; color: #4b5563;">
            {% if booking.notes %}
              {{ booking.notes }}
            {% else %}
              Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ù…Ø³Ø¬Ù„Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„Ø­Ø¬Ø².
            {% endif %}
          </div>
        </div>
      </div>
    </section>

    <!-- ğŸ« Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„Ø«Ø§Ù†ÙŠ â€“ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© -->
    {% with pass=booking.access_pass %}
    <section class="pass-card">
      <div class="card-header-line">
        <div>
          <h3>Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø±Ù‚Ù…ÙŠØ©</h3>
          <div class="card-subtitle">
            Ø¥Ø¯Ø§Ø±Ø© Ø­Ø§Ù„Ø© Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©ØŒ Ø§Ù„Ø±Ø§Ø¨Ø·ØŒ ÙˆØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„ØºØ±ÙØ©.
          </div>
        </div>

        {% if pass %}
          {% if pass.status == 'active' %}
            <span class="badge badge-chip badge-pass-active">
              <span class="badge-chip-dot"></span>
              Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© ÙØ¹Ù‘Ø§Ù„Ø©
            </span>
          {% elif pass.status == 'expired' %}
            <span class="badge badge-chip badge-pass-expired">
              <span class="badge-chip-dot"></span>
              Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ù…Ù†ØªÙ‡ÙŠØ©
            </span>
          {% elif pass.status == 'cancelled' %}
            <span class="badge badge-chip badge-pass-cancelled">
              <span class="badge-chip-dot"></span>
              Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ù…Ù„ØºØ§Ø©
            </span>
          {% else %}
            <span class="badge badge-chip badge-pass-none">
              <span class="badge-chip-dot"></span>
              Ø­Ø§Ù„Ø© ØºÙŠØ± Ù…Ø¹Ø±Ù‘ÙØ©
            </span>
          {% endif %}
        {% else %}
          <span class="badge badge-chip badge-pass-none">
            <span class="badge-chip-dot"></span>
            Ù„Ù… ØªÙÙ†Ø´Ø£ Ø¨Ø·Ø§Ù‚Ø© Ø¨Ø¹Ø¯
          </span>
        {% endif %}
      </div>

      {% if not pass %}
        <!-- Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨Ø·Ø§Ù‚Ø© -->
        <div class="pass-empty-state">
          Ù„Ù… ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø¨Ø·Ø§Ù‚Ø© Ø¯Ø®ÙˆÙ„ Ù„Ù‡Ø°Ø§ Ø§Ù„Ø­Ø¬Ø² Ø¨Ø¹Ø¯.<br>
          ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ù†Ø´Ø§Ø¡ Ø¨Ø·Ø§Ù‚Ø© Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ù‡Ø°Ù‡ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ© Ù„ÙØªØ­ Ø§Ù„ØºØ±ÙØ© Ù…Ù† Ø¬ÙˆØ§Ù„ Ø§Ù„Ù†Ø²ÙŠÙ„.
        </div>

        <a
          href="{% url 'create_access_pass' booking.id %}"
          class="btn-main"
        >
          ğŸŸ Ø¥Ù†Ø´Ø§Ø¡ Ø¨Ø·Ø§Ù‚Ø© Ø¯Ø®ÙˆÙ„
        </a>

      {% else %}
        <!-- ØªÙˆØ¬Ø¯ Ø¨Ø·Ø§Ù‚Ø© -->
        <div class="detail-row">
          <div class="detail-item">
            <div class="detail-label">Ø­Ø§Ù„Ø© Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©</div>
            <div class="detail-value">
              {% if pass.status == 'active' %}
                <span class="badge badge-chip badge-pass-active">
                  <span class="badge-chip-dot"></span>
                  ÙØ¹Ù‘Ø§Ù„Ø©
                </span>
              {% elif pass.status == 'expired' %}
                <span class="badge badge-chip badge-pass-expired">
                  <span class="badge-chip-dot"></span>
                  Ù…Ù†ØªÙ‡ÙŠØ©
                </span>
              {% elif pass.status == 'cancelled' %}
                <span class="badge badge-chip badge-pass-cancelled">
                  <span class="badge-chip-dot"></span>
                  Ù…Ù„ØºØ§Ø©
                </span>
              {% else %}
                <span class="badge badge-chip badge-pass-none">
                  <span class="badge-chip-dot"></span>
                  ØºÙŠØ± Ù…Ø¹Ø±Ù‘ÙØ©
                </span>
              {% endif %}
            </div>
          </div>

          <div class="detail-item">
            <div class="detail-label">ØªÙ†ØªÙ‡ÙŠ ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© ÙÙŠ</div>
            <div class="detail-value">
              {% if pass.expires_at %}
                {{ pass.expires_at|date:"d M Y - H:i" }}
                <span class="detail-meta-inline">
                  (Ø­Ø³Ø¨ ØªÙˆÙ‚ÙŠØª Ø§Ù„Ù†Ø¸Ø§Ù…)
                </span>
              {% else %}
                ØºÙŠØ± Ù…Ø­Ø¯Ø¯
              {% endif %}
            </div>
          </div>
        </div>

        <!-- Ø±Ø§Ø¨Ø· Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© -->
        <div class="detail-row" style="margin-top: 8px;">
          <div class="detail-item" style="width: 100%;">
            <div class="detail-label">Ø±Ø§Ø¨Ø· Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© (URL)</div>
            <div class="pass-url-box">
              <div class="pass-url-text" id="passUrlText">
                {{ pass.url }}
              </div>
              <button
                type="button"
                class="copy-badge"
                id="copyPassUrlBtn"
                data-url="{{ pass.url }}"
              >
                ğŸ“‹ Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·
              </button>
            </div>
          </div>
        </div>

        <!-- Ø§Ù„Ø£Ø²Ø±Ø§Ø± -->
        <div class="detail-row" style="margin-top: 8px;">
          <div class="detail-item" style="width: 100%; display: flex; gap: 8px; flex-wrap: wrap;">

            <a
              href="{{ pass.url }}"
              target="_blank"
              rel="noopener noreferrer"
              class="btn-main-secondary"
            >
              ğŸ”— ÙØªØ­ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© ÙÙŠ ØªØ¨ÙˆÙŠØ¨ Ø¬Ø¯ÙŠØ¯
            </a>

            {% if pass.status == 'active' %}
              <form
                action="{% url 'deactivate_access_pass' pass.id %}"
                method="post"
                style="margin: 0;"
                onsubmit="return confirmDeactivate();"
              >
                {% csrf_token %}
                <button type="submit" class="btn-outline-danger">
                  âœ– Ø¥Ù„ØºØ§Ø¡ / ØªØ¹Ø·ÙŠÙ„ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©
                </button>
              </form>
            {% endif %}
          </div>
        </div>

      {% endif %}
    </section>
    {% endwith %}

  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const copyBtn = document.getElementById('copyPassUrlBtn');

    if (copyBtn) {
      copyBtn.addEventListener('click', async function () {
        const url = copyBtn.getAttribute('data-url') || '';
        if (!url) return;

        try {
          await navigator.clipboard.writeText(url);
          copyBtn.classList.add('success');
          copyBtn.textContent = 'âœ… ØªÙ… Ø§Ù„Ù†Ø³Ø®';
          setTimeout(() => {
            copyBtn.classList.remove('success');
            copyBtn.textContent = 'ğŸ“‹ Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·';
          }, 1500);
        } catch (err) {
          alert('ØªØ¹Ø°Ù‘Ø± Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø· ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ØŒ ÙŠÙ…ÙƒÙ†Ùƒ Ù†Ø³Ø®Ù‡ ÙŠØ¯ÙˆÙŠØ§Ù‹.');
        }
      });
    }
  });

  function confirmDeactivate() {
    return confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ù„ØºØ§Ø¡ / ØªØ¹Ø·ÙŠÙ„ Ù‡Ø°Ù‡ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©ØŸ Ù„Ù† ÙŠØªÙ…ÙƒÙ† Ø§Ù„Ù†Ø²ÙŠÙ„ Ù…Ù† Ø§Ø³ØªØ®Ø¯Ø§Ù…Ù‡Ø§ Ø¨Ø¹Ø¯ Ø°Ù„Ùƒ.');
  }
</script>
{% endblock %}
